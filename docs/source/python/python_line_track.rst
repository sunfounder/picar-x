.. note::

    ã“ã‚“ã«ã¡ã¯ã€SunFounderã®Raspberry Pi & Arduino & ESP32æ„›å¥½å®¶ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¸ã‚ˆã†ã“ãï¼Facebookä¸Šã§Raspberry Piã€Arduinoã€ESP32ã«ã¤ã„ã¦ã‚‚ã£ã¨æ·±ãæ˜ã‚Šä¸‹ã’ã€ä»–ã®æ„›å¥½å®¶ã¨äº¤æµã—ã¾ã—ã‚‡ã†ã€‚

    **å‚åŠ ã™ã‚‹ç†ç”±ã¯ï¼Ÿ**

    - **ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã‚µãƒãƒ¼ãƒˆ**ï¼šã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚„ãƒãƒ¼ãƒ ã®åŠ©ã‘ã‚’å€Ÿã‚Šã¦ã€è²©å£²å¾Œã®å•é¡Œã‚„æŠ€è¡“çš„ãªèª²é¡Œã‚’è§£æ±ºã—ã¾ã™ã€‚
    - **å­¦ã³ï¼†å…±æœ‰**ï¼šãƒ’ãƒ³ãƒˆã‚„ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’äº¤æ›ã—ã¦ã‚¹ã‚­ãƒ«ã‚’å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†ã€‚
    - **ç‹¬å çš„ãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**ï¼šæ–°è£½å“ã®ç™ºè¡¨ã‚„å…ˆè¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«æ—©æœŸã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚
    - **ç‰¹åˆ¥å‰²å¼•**ï¼šæœ€æ–°è£½å“ã®ç‹¬å å‰²å¼•ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚
    - **ç¥­ã‚Šã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚®ãƒ•ãƒˆ**ï¼šã‚®ãƒ•ãƒˆã‚„ç¥æ—¥ã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã«å‚åŠ ã—ã¾ã—ã‚‡ã†ã€‚

    ğŸ‘‰ ç§ãŸã¡ã¨ä¸€ç·’ã«æ¢ç´¢ã—ã€å‰µé€ ã™ã‚‹æº–å‚™ã¯ã§ãã¦ã„ã¾ã™ã‹ï¼Ÿ[|link_sf_facebook|]ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä»Šã™ãå‚åŠ ã—ã¾ã—ã‚‡ã†ï¼

.. _py_line_tracking:

5. ãƒ©ã‚¤ãƒ³è¿½è·¡
====================================

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€PiCar-Xã‚’ç·šã«æ²¿ã£ã¦å‰é€²ã•ã›ã¾ã™ã€‚
ã§ãã‚‹ã ã‘ã¾ã£ã™ãã§ã€ã‚ã¾ã‚Šæ›²ãŒã£ã¦ã„ãªã„æš—è‰²ã®ãƒ†ãƒ¼ãƒ—ã‚’ä½¿ã£ã¦ç·šã‚’ä½œã‚Šã¾ã™ã€‚
PiCar-XãŒè„±ç·šã—ãŸå ´åˆã¯ã€ã„ãã¤ã‹ã®å®Ÿé¨“ãŒå¿…è¦ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

**ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œ**

.. raw:: html

    <run></run>

.. code-block::

    cd ~/picar-x/example
    sudo python3 5.minecart_plus.py
    
ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€PiCar-Xã¯ç·šã«æ²¿ã£ã¦å‰é€²ã—ã¾ã™ã€‚

**ã‚³ãƒ¼ãƒ‰**

.. note::
    ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ **å¤‰æ›´/ãƒªã‚»ãƒƒãƒˆ/ã‚³ãƒ”ãƒ¼/å®Ÿè¡Œ/åœæ­¢** ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ã‹ã—ã€ãã‚Œã‚’ã™ã‚‹å‰ã«ã€ ``picar-x/example`` ã®ã‚ˆã†ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒ‘ã‚¹ã«ç§»å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãŸå¾Œã€ç›´æ¥å®Ÿè¡Œã—ã¦åŠ¹æœã‚’ç¢ºèªã§ãã¾ã™ã€‚


.. raw:: html

    <run></run>

.. code-block:: python

    from picarx import Picarx
    from time import sleep

    px = Picarx()
    # px = Picarx(grayscale_pins=['A0', 'A1', 'A2'])

    # Please run ./calibration/grayscale_calibration.py to Auto calibrate grayscale values
    # or manual modify reference value by follow code
    # px.set_line_reference([1400, 1400, 1400])

    current_state = None
    px_power = 10
    offset = 20
    last_state = "stop"

    def outHandle():
        global last_state, current_state
        if last_state == 'left':
            px.set_dir_servo_angle(-30)
            px.backward(10)
        elif last_state == 'right':
            px.set_dir_servo_angle(30)
            px.backward(10)
        while True:
            gm_val_list = px.get_grayscale_data()
            gm_state = get_status(gm_val_list)
            print("outHandle gm_val_list: %s, %s"%(gm_val_list, gm_state))
            currentSta = gm_state
            if currentSta != last_state:
                break
        sleep(0.001)

    def get_status(val_list):
        _state = px.get_line_status(val_list)  # [bool, bool, bool], 0 means line, 1 means background
        if _state == [0, 0, 0]:
            return 'stop'
        elif _state[1] == 1:
            return 'forward'
        elif _state[0] == 1:
            return 'right'
        elif _state[2] == 1:
            return 'left'

    if __name__=='__main__':
        try:
            while True:
                gm_val_list = px.get_grayscale_data()
                gm_state = get_status(gm_val_list)
                print("gm_val_list: %s, %s"%(gm_val_list, gm_state))

                if gm_state != "stop":
                    last_state = gm_state

                if gm_state == 'forward':
                    px.set_dir_servo_angle(0)
                    px.forward(px_power) 
                elif gm_state == 'left':
                    px.set_dir_servo_angle(offset)
                    px.forward(px_power) 
                elif gm_state == 'right':
                    px.set_dir_servo_angle(-offset)
                    px.forward(px_power) 
                else:
                    outHandle()
        finally:
            px.stop()
            print("stop and exit")
            sleep(0.1)

                
**ã©ã®ã‚ˆã†ã«å‹•ä½œã™ã‚‹ã®ã‹ï¼Ÿ**

ã“ã®Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã‚»ãƒ³ã‚µãƒ¼ã‚’ä½¿ç”¨ã—ã¦Picarxãƒ­ãƒœãƒƒãƒˆã‚«ãƒ¼ã‚’ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚ä¸»ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

* ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨åˆæœŸåŒ–ï¼š

    ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ãƒ­ãƒœãƒƒãƒˆã‚«ãƒ¼ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã® ``Picarx`` ã‚¯ãƒ©ã‚¹ã¨ã€é…å»¶ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®timeãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã® ``sleep`` é–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

    ``Picarx`` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã€ç‰¹å®šã®ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã‚»ãƒ³ã‚µãƒ¼ãƒ”ãƒ³ã§ã®ä»£æ›¿åˆæœŸåŒ–ã‚’ç¤ºã™ã‚³ãƒ¡ãƒ³ãƒˆä»˜ãã®è¡ŒãŒã‚ã‚Šã¾ã™ã€‚

    .. code-block:: python

        from picarx import Picarx
        from time import sleep

        px = Picarx()

* è¨­å®šã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼š

    ``current_state``ã€ ``px_power``ã€ ``offset``ã€ ``last_state`` ã¯ã€è»Šã®å‹•ãã‚’è¿½è·¡ãŠã‚ˆã³åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ã™ã€‚ ``px_power`` ã¯ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®ãƒ‘ãƒ¯ãƒ¼ã‚’è¨­å®šã—ã€ ``offset`` ã¯ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°è§’åº¦ã‚’èª¿æ•´ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

    .. code-block:: python

        current_state = None
        px_power = 10
        offset = 20
        last_state = "stop"

* ``outHandle`` é–¢æ•°ï¼š

    ã“ã®é–¢æ•°ã¯ã€è»ŠãŒã€Œãƒ©ã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã€ã®ã‚·ãƒŠãƒªã‚ªã‚’å‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

    ãã‚Œã¯ ``last_state`` ã«åŸºã¥ã„ã¦è»Šã®æ–¹å‘ã‚’èª¿æ•´ã—ã€æ–°ã—ã„çŠ¶æ…‹ã‚’æ±ºå®šã™ã‚‹ãŸã‚ã«ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã‚»ãƒ³ã‚µãƒ¼ã®å€¤ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

    .. code-block:: python

        def outHandle():
            global last_state, current_state
            if last_state == 'left':
                px.set_dir_servo_angle(-30)
                px.backward(10)
            elif last_state == 'right':
                px.set_dir_servo_angle(30)
                px.backward(10)
            while True:
                gm_val_list = px.get_grayscale_data()
                gm_state = get_status(gm_val_list)
                print("outHandle gm_val_list: %s, %s"%(gm_val_list, gm_state))
                currentSta = gm_state
                if currentSta != last_state:
                    break
            sleep(0.001)

* ``get_status`` é–¢æ•°ï¼š

    ã“ã®é–¢æ•°ã¯ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆ ``val_list`` ï¼‰ã‚’è§£é‡ˆã—ã€è»Šã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ±ºå®šã—ã¾ã™ã€‚

    è»Šã®çŠ¶æ…‹ã¯ã€ã©ã®ã‚»ãƒ³ã‚µãƒ¼ãŒãƒ©ã‚¤ãƒ³ã‚’æ¤œå‡ºã™ã‚‹ã‹ã«åŸºã¥ã„ã¦ã€ ``forward`` ã€ ``left`` ã€ ``right`` ã¾ãŸã¯ ``stop`` ã«ãªã‚Šã¾ã™ã€‚

    .. code-block:: python

        def get_status(val_list):
            _state = px.get_line_status(val_list)  # [bool, bool, bool], 0ã¯ãƒ©ã‚¤ãƒ³ã€1ã¯èƒŒæ™¯ã‚’æ„å‘³ã—ã¾ã™
            if _state == [0, 0, 0]:
                return 'stop'
            elif _state[1] == 1:
                return 'forward'
            elif _state[0] == 1:
                return 'right'
            elif _state[2] == 1:
                return 'left'
    
* Main Loop: 

    * ``while True`` ãƒ«ãƒ¼ãƒ—ã¯ç¶™ç¶šçš„ã«ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãã‚Œã«å¿œã˜ã¦è»Šã®å‹•ãã‚’èª¿æ•´ã—ã¾ã™ã€‚

    * ``gm_state`` ã«å¿œã˜ã¦ã€ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°è§’åº¦ã¨å‹•ãã®æ–¹å‘ã‚’è¨­å®šã—ã¾ã™ã€‚

    .. code-block:: python

        if __name__=='__main__':
            try:
                while True:
                    gm_val_list = px.get_grayscale_data()
                    gm_state = get_status(gm_val_list)
                    print("gm_val_list: %s, %s"%(gm_val_list, gm_state))

                    if gm_state != "stop":
                        last_state = gm_state

                    if gm_state == 'forward':
                        px.set_dir_servo_angle(0)
                        px.forward(px_power) 
                    elif gm_state == 'left':
                        px.set_dir_servo_angle(offset)
                        px.forward(px_power) 
                    elif gm_state == 'right':
                        px.set_dir_servo_angle(-offset)
                        px.forward(px_power) 
                    else:
                        outHandle()

* å®‰å…¨æ€§ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼š

    ``try...finally`` ãƒ–ãƒ­ãƒƒã‚¯ã¯ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä¸­æ–­ã¾ãŸã¯çµ‚äº†ã—ãŸã¨ãã«è»ŠãŒåœæ­¢ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

    .. code-block:: python

        finally:
        px.stop()
        print("stop and exit")
        sleep(0.1)

è¦ç´„ã™ã‚‹ã¨ã€ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã‚»ãƒ³ã‚µãƒ¼ã‚’ä½¿ç”¨ã—ã¦Picarxãƒ­ãƒœãƒƒãƒˆã‚«ãƒ¼ã‚’ãƒŠãƒ“ã‚²ãƒ¼ãƒˆã—ã¾ã™ã€‚ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç¶™ç¶šçš„ã«èª­ã¿å–ã‚Šã€æ–¹å‘ã‚’æ±ºå®šã—ã€ãã‚Œã«å¿œã˜ã¦è»Šã®å‹•ãã¨ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°ã‚’èª¿æ•´ã—ã¾ã™ã€‚outHandleé–¢æ•°ã¯ã€è»ŠãŒå¤§ãããƒ‘ã‚¹ã‚’èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã®è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯ã‚’æä¾›ã—ã¾ã™ã€‚